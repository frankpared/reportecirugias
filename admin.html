<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Reportes Guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <!-- Firebase SDK (compat version para firestore() v8) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body class="fondo-dinamico">
  <div class="container">
    <header style="margin-bottom: 30px;">
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 80px; display: block; margin: 0 auto 15px auto;" />
      <h2 style="text-align: center; color: #333;">üìã Reportes Guardados</h2>
    </header>

    <div class="table-responsive" style="overflow-x: auto;">
      <table style="width:100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <thead style="background-color: #007bff; color: white;">
          <tr>
            <th style="padding: 12px 15px; text-align: left;">Fecha Cirug√≠a</th>
            <th style="padding: 12px 15px; text-align: left;">Paciente</th>
            <th style="padding: 12px 15px; text-align: left;">M√©dico</th>
            <th style="padding: 12px 15px; text-align: left;">Tipo Cirug√≠a</th>
            <th style="padding: 12px 15px; text-align: left;">Material (Inicio)</th>
            <th style="padding: 12px 15px; text-align: left;">Usuario ID</th>
            <th style="padding: 12px 15px; text-align: left;">Guardado En</th>
          </tr>
        </thead>
        <tbody id="reporte-rows" style="background-color: #fff;">
          <!-- Las filas se cargar√°n aqu√≠ -->
           <tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="btn-volver" style="background-color: #6c757d;">‚Üê Volver al formulario</a>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase (DEBE SER LA MISMA QUE EN script.js)
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E", // Mant√©n tu API Key real
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Habilitar persistencia (opcional pero bueno para offline)
    db.enablePersistence()
      .catch((err) => {
         if (err.code == 'failed-precondition') {
          console.warn("Persistencia admin fall√≥: M√∫ltiples pesta√±as?");
        } else if (err.code == 'unimplemented') {
          console.warn("Persistencia admin no soportada.");
        } else {
          console.error("Error habilitando persistencia admin:", err);
        }
      });

    // Formatea la fecha ISO (YYYY-MM-DD) a formato local
    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            const partes = fechaISO.split('-');
            if (partes.length !== 3) return fechaISO;
            const fecha = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]), 12, 0, 0);
            return fecha.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) { return fechaISO; }
    }

     // Formatea el timestamp de Firestore a fecha y hora local
    function formatearTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        try {
            return timestamp.toDate().toLocaleString('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        } catch (e) { return '-'; }
    }


    // Carga los reportes desde Firestore
    function cargarReportes() {
      const tbody = document.getElementById("reporte-rows");
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>'; // Colspan 7 ahora

      db.collection("reportes")
        .orderBy("timestamp", "desc") // Ordenar por fecha de guardado, m√°s reciente primero
        .limit(100) // Limitar a los √∫ltimos 100 para no sobrecargar
        .get()
        .then(snapshot => {
          tbody.innerHTML = ''; // Limpiar 'Cargando...'
          if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #777;">No hay reportes guardados todav√≠a.</td></tr>';
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const fechaCirugiaFormateada = formatearFechaLocal(data.fechaCirugia);
            const fechaGuardadoFormateada = formatearTimestamp(data.timestamp);
            const materialCortado = data.material ? (data.material.substring(0, 40) + (data.material.length > 40 ? '...' : '')) : 'No especificado';
            const usuarioIdCorto = data.usuario ? data.usuario.substring(0, 6) : 'An√≥nimo';

            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid #eee"; // Separador visual

            // Usar textContent para seguridad b√°sica contra XSS
            const createCell = (text) => {
                const td = document.createElement('td');
                td.textContent = text || '-'; // Mostrar gui√≥n si est√° vac√≠o
                td.style.padding = "10px 15px";
                td.style.verticalAlign = "top";
                return td;
            };

            tr.appendChild(createCell(fechaCirugiaFormateada));
            tr.appendChild(createCell(data.paciente));
            tr.appendChild(createCell(data.medico));
            tr.appendChild(createCell(data.tipoCirugia));
            tr.appendChild(createCell(materialCortado));
            tr.appendChild(createCell(usuarioIdCorto));
            tr.appendChild(createCell(fechaGuardadoFormateada));

            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error cargando reportes:', error);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:red;">Error al cargar los reportes. Revise la consola.</td></tr>';
        });
    }

    // Aplica fondo din√°mico (opcional)
    function aplicarFondoDinamico() {
        // C√≥digo de fondo din√°mico (si lo quieres mantener)
        // ... (el mismo c√≥digo de antes) ...
        // O simplemente un fondo fijo:
        document.body.style.backgroundColor = "#e9f0f5"; // Fondo simple
    }

    // Ejecutar al cargar la p√°gina
    window.onload = function () {
      aplicarFondoDinamico();
      cargarReportes();
    };
  </script>
</body>
</html>
