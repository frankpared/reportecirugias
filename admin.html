<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Reportes Guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body class="fondo-dinamico admin-page">
  <div class="container">
    <header style="margin-bottom: 30px;">
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 80px; display: block; margin: 0 auto 15px auto;" />
      <h2 style="text-align: center; color: #333; font-family: 'Poppins', sans-serif;">üìã Reportes Guardados</h2>
    </header>

    <div class="admin-controls">
      <input type="text" id="searchInputAdmin" class="form-control" placeholder="Buscar por Cliente, Paciente o M√©dico..." onkeyup="filtrarTablaAdmin()">
    </div>

    <div class="table-responsive">
      <table id="reportesTableAdmin" style="width:100%;">
        <thead>
          <tr>
            <th>Fecha Cir.</th>
            <th>Cliente</th>
            <th>Paciente</th>
            <th>M√©dico</th>
            <th>Tipo Cirug√≠a</th>
            <th>Guardado En</th>
            <th>Acciones</th> 
          </tr>
        </thead>
        <tbody id="reporte-rows-admin">
           <tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="btn-volver">‚Üê Volver al formulario</a>
    </div>
  </div>

  <!-- Modal para Ver Detalle del Reporte -->
  <div id="modalReporteDetalle" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Detalle del Reporte</h3>
        <button class="modal-close-btn" onclick="cerrarModalReporteDetalle()">√ó</button>
      </div>
      <div class="modal-body" id="modalReporteDetalleBody">
        <!-- El contenido del reporte se insertar√° aqu√≠ -->
      </div>
      <div class="modal-footer">
         <button type="button" class="btn-link" onclick="cerrarModalReporteDetalle()">Cerrar</button>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast-notification" style="display:none;"></div>


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E",
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let todosLosReportes = []; // Para guardar los reportes y filtrar en cliente

    db.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') console.warn("Persistencia admin fall√≥");
        else if (err.code == 'unimplemented') console.warn("Persistencia admin no soportada.");
    });

    function mostrarToastAdmin(mensaje, tipo = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = mensaje; toast.className = 'toast-notification'; toast.classList.add(tipo);
        toast.style.display = 'block'; void toast.offsetWidth;
        toast.style.opacity = '1'; toast.style.transform = 'translateY(0)';
        setTimeout(() => {
            toast.style.opacity = '0'; toast.style.transform = 'translateY(20px)';
            setTimeout(() => { toast.style.display = 'none'; }, 300);
        }, 3000);
    }

    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            const partes = fechaISO.split('-');
            if (partes.length !== 3) return fechaISO;
            const fecha = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]), 12, 0, 0);
            return fecha.toLocaleDateString('es-AR', { year: '2-digit', month: '2-digit', day: '2-digit' }); // A√±o corto
        } catch (e) { return fechaISO; }
    }

    function formatearTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        try {
            return timestamp.toDate().toLocaleString('es-AR', {
                year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
        } catch (e) { return '-'; }
    }
    
    // Funciones para generar HTML del reporte (copiadas/adaptadas de script.js)
    function formatearMaterialParaHTMLAdmin(materialTexto) {
        if (!materialTexto) return '<p>No especificado.</p>';
        const lineas = materialTexto.split('\n').filter(linea => linea.trim() !== '');
        if (lineas.length === 0) return '<p>No especificado.</p>';
        let tablaHTML = '<table class="material-table">';
        lineas.forEach(linea => { tablaHTML += `<tr><td>${linea.trim()}</td></tr>`; });
        tablaHTML += '</table>';
        return tablaHTML;
    }

    function generarHTMLReporteAdmin(datos) {
        const fraseFinal = "\n\nSaludos, quedo al pendiente.";
        const fechaCirugiaFormateada = formatearFechaLocal(datos.fechaCirugia); // Usar la local para el modal
        const contenidoMaterialHTML = formatearMaterialParaHTMLAdmin(datos.material);
        return `
        <div class="reporte-contenido reporte-box">
            <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 60px; margin-bottom: 10px; display: block; margin: 0 auto;">
            <h3>Detalle de Cirug√≠a</h3>
            <p>${datos.mensajeInicio || 'Detalles de la cirug√≠a programada:'}</p>
            <ul>
            <li><strong>Cliente:</strong> ${datos.cliente || 'No especificado'}</li>
            <li><strong>Paciente:</strong> ${datos.paciente || 'No especificado'}</li>
            <li><strong>Tipo de Cirug√≠a:</strong> ${datos.tipoCirugia || 'No especificado'}</li>
            <li><strong>M√©dico:</strong> ${datos.medico || 'No especificado'}</li>
            <li><strong>Instrumentador:</strong> ${datos.instrumentador || 'No especificado'}</li>
            <li><strong>Fecha Cirug√≠a:</strong> ${fechaCirugiaFormateada}</li>
            <li><strong>Lugar:</strong> ${datos.lugarCirugia || 'No especificado'}</li>
            </ul>
            <h4>Material Requerido:</h4>
            ${contenidoMaterialHTML}
            ${datos.observaciones ? `<h4>Observaciones:</h4><p>${datos.observaciones.replace(/\n/g, '<br>')}</p>` : ''}
            ${datos.infoAdicional ? `<h4>Info. Adicional:</h4><p>${datos.infoAdicional.replace(/\n/g, '<br>')}</p>` : ''}
            <p style="margin-top: 15px;">${fraseFinal.trim().replace(/\n/g, '<br>')}</p>
        </div>`;
    }


    function abrirModalReporteDetalle(reporteData) {
        const modal = document.getElementById('modalReporteDetalle');
        const body = document.getElementById('modalReporteDetalleBody');
        if (!modal || !body) return;
        
        body.innerHTML = generarHTMLReporteAdmin(reporteData); // Usar la funci√≥n para generar el HTML

        modal.classList.add('visible');
        modal.style.display = 'flex';
    }

    function cerrarModalReporteDetalle() {
        const modal = document.getElementById('modalReporteDetalle');
        if (modal) {
            modal.classList.remove('visible');
            setTimeout(() => { modal.style.display = 'none'; document.getElementById('modalReporteDetalleBody').innerHTML = ''; }, 300);
        }
    }
    const modalDetalle = document.getElementById('modalReporteDetalle');
    if (modalDetalle) {
        modalDetalle.addEventListener('click', function(event) {
            if (event.target === this) cerrarModalReporteDetalle();
        });
    }

    function reenviarWhatsAppAdmin(reporteData) {
        const reporteHTMLTemporal = generarHTMLReporteAdmin(reporteData);
        const divTemporal = document.createElement('div');
        divTemporal.innerHTML = reporteHTMLTemporal;
        const textoPlano = `*Reporte de Cirug√≠a Districorr (Reenv√≠o Admin)*\n\n${divTemporal.querySelector('.reporte-contenido').innerText}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(textoPlano)}`, '_blank');
        mostrarToastAdmin('Preparando reenv√≠o por WhatsApp...', 'info');
    }


    function cargarReportesAdmin() {
      const tbody = document.getElementById("reporte-rows-admin");
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>`;

      db.collection("reportes").orderBy("timestamp", "desc").limit(150) // Un poco m√°s para admin
        .get()
        .then(snapshot => {
          tbody.innerHTML = '';
          todosLosReportes = []; // Limpiar antes de llenar
          if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px; color: #777;">No hay reportes.</td></tr>`;
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id; // Guardar el ID del documento para futuras acciones
            todosLosReportes.push(data); // Guardar para filtrar

            const tr = document.createElement("tr");
            tr.dataset.reporteId = doc.id; // Para identificar la fila

            const createCell = (text, className = '') => {
                const td = document.createElement('td');
                td.textContent = text || '-';
                if(className) td.classList.add(className);
                return td;
            };
            
            tr.appendChild(createCell(formatearFechaLocal(data.fechaCirugia)));
            tr.appendChild(createCell(data.cliente, 'col-cliente'));
            tr.appendChild(createCell(data.paciente, 'col-paciente'));
            tr.appendChild(createCell(data.medico, 'col-medico'));
            tr.appendChild(createCell(data.tipoCirugia ? data.tipoCirugia.substring(0,25)+'...' : '-', 'col-tipocx'));
            tr.appendChild(createCell(formatearTimestamp(data.timestamp)));
            
            // Celda de Acciones
            const tdActions = document.createElement('td');
            tdActions.classList.add('col-acciones');

            const btnVer = document.createElement('button');
            btnVer.textContent = 'Ver';
            btnVer.classList.add('btn-admin-action', 'btn-admin-ver');
            btnVer.onclick = ()_ModalReporteDetalle(data);
            tdActions.appendChild(btnVer);
            
            const btnWsp = document.createElement('button');
            btnWsp.innerHTML = 'üì≤'; // Icono WhatsApp
            btnWsp.title = 'Reenviar por WhatsApp';
            btnWsp.classList.add('btn-admin-action', 'btn-admin-wsp');
            btnWsp.onclick = ()_enviarWhatsAppAdmin(data);
            tdActions.appendChild(btnWsp);

            // Aqu√≠ podr√≠as a√±adir m√°s botones (Editar, Eliminar) en el futuro
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error cargando reportes admin:', error);
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:red;">Error al cargar.</td></tr>`;
        });
    }

    function filtrarTablaAdmin() {
        const input = document.getElementById("searchInputAdmin");
        const filter = input.value.toUpperCase().trim();
        const tbody = document.getElementById("reporte-rows-admin");
        const rows = tbody.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (!row.dataset.reporteId) { // Si es la fila de "cargando" o "no hay reportes"
                 row.classList.remove('fila-oculta');
                 continue;
            }
            
            const reporteId = row.dataset.reporteId;
            const reporteData = todosLosReportes.find(r => r.id === reporteId);

            if (reporteData) {
                const cliente = (reporteData.cliente || "").toUpperCase();
                const paciente = (reporteData.paciente || "").toUpperCase();
                const medico = (reporteData.medico || "").toUpperCase();
                
                if (cliente.includes(filter) || paciente.includes(filter) || medico.includes(filter)) {
                    row.classList.remove('fila-oculta');
                } else {
                    row.classList.add('fila-oculta');
                }
            } else {
                 row.classList.add('fila-oculta'); // Ocultar si no se encuentran datos
            }
        }
    }
    
    window.onload = function () {
      document.body.style.backgroundColor = "#f0f2f5"; // Fondo fijo para admin
      cargarReportesAdmin();
    };
  </script>
</body>
</html>
