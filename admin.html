<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Reportes Guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <!-- Firebase SDK (compat version para firestore() v8) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body class="fondo-dinamico admin-page">
  <div class="container">
    <header style="margin-bottom: 30px;">
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 80px; display: block; margin: 0 auto 15px auto;" />
      <h2 style="text-align: center; color: #333; font-family: 'Poppins', sans-serif;">üìã Reportes Guardados</h2>
    </header>

    <div class="table-responsive">
      <table id="reportesTable" style="width:100%;">
        <thead>
          <tr>
            <th>Fecha Cirug√≠a</th>
            <th>Cliente</th> {/* NUEVA COLUMNA */}
            <th>Paciente</th>
            <th>M√©dico</th>
            <th>Tipo Cirug√≠a</th>
            <th>Material (Inicio)</th>
            <th>Usuario ID</th>
            <th>Guardado En</th>
          </tr>
        </thead>
        <tbody id="reporte-rows">
           <tr><td colspan="8" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr> {/* Colspan actualizado a 8 */}
        </tbody>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="btn-volver">‚Üê Volver al formulario</a>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E",
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    db.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') console.warn("Persistencia admin fall√≥: M√∫ltiples pesta√±as?");
        else if (err.code == 'unimplemented') console.warn("Persistencia admin no soportada.");
        else console.error("Error habilitando persistencia admin:", err);
    });

    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            const partes = fechaISO.split('-');
            if (partes.length !== 3) return fechaISO;
            const fecha = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]), 12, 0, 0);
            return fecha.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) { return fechaISO; }
    }

    function formatearTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        try {
            return timestamp.toDate().toLocaleString('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        } catch (e) { return '-'; }
    }

    function cargarReportes() {
      const tbody = document.getElementById("reporte-rows");
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>'; // Colspan 8

      db.collection("reportes")
        .orderBy("timestamp", "desc")
        .limit(100)
        .get()
        .then(snapshot => {
          tbody.innerHTML = '';
          if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color: #777;">No hay reportes guardados todav√≠a.</td></tr>'; // Colspan 8
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const fechaCirugiaFormateada = formatearFechaLocal(data.fechaCirugia);
            const fechaGuardadoFormateada = formatearTimestamp(data.timestamp);
            const materialCortado = data.material ? (data.material.substring(0, 40) + (data.material.length > 40 ? '...' : '')) : '-';
            const usuarioIdCorto = data.usuario ? data.usuario.substring(0, 6) : 'An√≥n.';

            const tr = document.createElement("tr");
            const createCell = (text) => {
                const td = document.createElement('td');
                td.textContent = text || '-';
                return td;
            };

            tr.appendChild(createCell(fechaCirugiaFormateada));
            tr.appendChild(createCell(data.cliente)); // CELDA CLIENTE A√ëADIDA
            tr.appendChild(createCell(data.paciente));
            tr.appendChild(createCell(data.medico));
            tr.appendChild(createCell(data.tipoCirugia));
            tr.appendChild(createCell(materialCortado));
            tr.appendChild(createCell(usuarioIdCorto));
            tr.appendChild(createCell(fechaGuardadoFormateada));

            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error cargando reportes:', error);
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color:red;">Error al cargar los reportes. Revise la consola.</td></tr>'; // Colspan 8
        });
    }

    function aplicarFondoDinamico() {
        document.body.style.backgroundColor = "#f0f2f5";
    }

    window.onload = function () {
      aplicarFondoDinamico();
      cargarReportes();
    };
  </script>
</body>
</html>
