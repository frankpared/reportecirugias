<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Reportes Guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <!-- Firebase SDK (compat version para firestore() v8) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<!-- A√±adir clase 'admin-page' para estilos espec√≠ficos si es necesario -->
<body class="fondo-dinamico admin-page">
  <div class="container">
    <header style="margin-bottom: 30px;">
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 80px; display: block; margin: 0 auto 15px auto;" />
      <h2 style="text-align: center; color: #333; font-family: 'Poppins', sans-serif;">üìã Reportes Guardados</h2>
    </header>

    <!-- Opcional: A√±adir un campo de b√∫squeda (requiere JS adicional para funcionar) -->
    <!--
    <div class="form-group" style="margin-bottom: 20px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar por paciente o m√©dico..." onkeyup="filtrarTabla()">
    </div>
    -->

    <div class="table-responsive">
      <table id="reportesTable" style="width:100%;">
        <thead>
          <tr>
            <!-- Columnas reordenadas y a√±adidas -->
            <th>Fecha Cirug√≠a</th>
            <th>Paciente</th>
            <th>M√©dico</th>
            <th>Tipo Cirug√≠a</th>
            <th>Material (Inicio)</th>
            <th>Usuario ID</th>
            <th>Guardado En</th>
          </tr>
        </thead>
        <tbody id="reporte-rows">
          <!-- Las filas se cargar√°n aqu√≠ -->
           <tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="btn-volver">‚Üê Volver al formulario</a>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase (DEBE SER LA MISMA QUE EN script.js)
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E", // ¬°ASEG√öRATE DE QUE ESTA SEA TU API KEY REAL!
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Habilitar persistencia (opcional pero bueno para offline)
    db.enablePersistence()
      .catch((err) => {
         if (err.code == 'failed-precondition') {
          console.warn("Persistencia admin fall√≥: M√∫ltiples pesta√±as?");
        } else if (err.code == 'unimplemented') {
          console.warn("Persistencia admin no soportada.");
        } else {
          console.error("Error habilitando persistencia admin:", err);
        }
      });

    // Formatea la fecha ISO (YYYY-MM-DD) a formato local
    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            // Interpretar la fecha como local a√±adiendo hora
            const partes = fechaISO.split('-');
            if (partes.length !== 3) return fechaISO;
            const fecha = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]), 12, 0, 0);
            return fecha.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) { return fechaISO; }
    }

     // Formatea el timestamp de Firestore a fecha y hora local
    function formatearTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        try {
            return timestamp.toDate().toLocaleString('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        } catch (e) { return '-'; }
    }

    // Carga los reportes desde Firestore y los muestra en la tabla
    function cargarReportes() {
      const tbody = document.getElementById("reporte-rows");
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>'; // Colspan 7 ahora

      db.collection("reportes")
        .orderBy("timestamp", "desc") // Ordenar por fecha de guardado, m√°s reciente primero
        .limit(100) // Limitar a los √∫ltimos 100 para rendimiento
        .get()
        .then(snapshot => {
          tbody.innerHTML = ''; // Limpiar 'Cargando...'
          if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color: #777;">No hay reportes guardados todav√≠a.</td></tr>';
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            const fechaCirugiaFormateada = formatearFechaLocal(data.fechaCirugia);
            const fechaGuardadoFormateada = formatearTimestamp(data.timestamp);
            // Acortar material para visualizaci√≥n en tabla
            const materialCortado = data.material
                ? (data.material.substring(0, 40) + (data.material.length > 40 ? '...' : ''))
                : '-'; // Mostrar gui√≥n si no hay material
            const usuarioIdCorto = data.usuario ? data.usuario.substring(0, 6) : 'An√≥n.'; // Acortar ID y poner texto si es an√≥nimo

            const tr = document.createElement("tr");

            // Helper para crear celdas de forma segura
            const createCell = (text) => {
                const td = document.createElement('td');
                td.textContent = text || '-'; // Mostrar gui√≥n si el valor es null/undefined/vac√≠o
                return td;
            };

            // A√±adir celdas en el orden correcto de las columnas
            tr.appendChild(createCell(fechaCirugiaFormateada));
            tr.appendChild(createCell(data.paciente));
            tr.appendChild(createCell(data.medico));
            tr.appendChild(createCell(data.tipoCirugia));
            tr.appendChild(createCell(materialCortado));
            tr.appendChild(createCell(usuarioIdCorto));
            tr.appendChild(createCell(fechaGuardadoFormateada));

            tbody.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Error cargando reportes:', error);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:red;">Error al cargar los reportes. Revise la consola.</td></tr>';
        });
    }

    // Aplica fondo din√°mico (opcional) o un fondo fijo
    function aplicarFondoDinamico() {
        document.body.style.backgroundColor = "#f0f2f5"; // Un gris ligeramente diferente para admin
    }

    // Opcional: Funci√≥n para filtrar la tabla (si descomentas el input de b√∫squeda)
    
    function filtrarTabla() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toUpperCase();
      const table = document.getElementById("reportesTable");
      const tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

      for (let i = 0; i < tr.length; i++) {
        // Buscar en columna Paciente (√≠ndice 1) y M√©dico (√≠ndice 2)
        const tdPaciente = tr[i].getElementsByTagName("td")[1];
        const tdMedico = tr[i].getElementsByTagName("td")[2];
        let mostrar = false;

        if (tdPaciente) {
          const txtValuePaciente = tdPaciente.textContent || tdPaciente.innerText;
          if (txtValuePaciente.toUpperCase().indexOf(filter) > -1) {
            mostrar = true;
          }
        }
        if (!mostrar && tdMedico) { // Solo buscar en m√©dico si no coincidi√≥ paciente
           const txtValueMedico = tdMedico.textContent || tdMedico.innerText;
           if (txtValueMedico.toUpperCase().indexOf(filter) > -1) {
            mostrar = true;
          }
        }

        if (mostrar) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
    

    // Ejecutar al cargar la p√°gina
    window.onload = function () {
      aplicarFondoDinamico();
      cargarReportes();
    };
  </script>
</body>
</html>
