<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Reportes Guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <!-- Firebase SDK (compat version para firestore() v8) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js para estad√≠sticas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .stats-section {
      margin-top: 30px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .stats-section h3 {
      text-align: center;
      color: #0056b3;
      margin-bottom: 20px;
    }
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-around;
    }
    .chart-wrapper {
      flex: 1 1 45%; /* Cada gr√°fico ocupa ~45% del ancho, permitiendo 2 por fila */
      min-width: 300px; /* Ancho m√≠nimo para gr√°ficos peque√±os */
      max-width: 600px; /* Ancho m√°ximo */
      background-color: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #auditLogModal .modal-content {
        max-width: 800px; /* Modal m√°s ancho para logs */
    }
    #auditLogModal .log-entry {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
    }
    #auditLogModal .log-entry:last-child {
        border-bottom: none;
    }
    #auditLogModal .log-timestamp {
        font-weight: bold;
        color: #555;
        margin-right: 10px;
    }
    #auditLogModal .log-user {
        color: #007bff;
        margin-right: 10px;
    }
     #auditLogModal .log-details-title {
        font-weight: bold;
        margin-top: 5px;
        display: block;
    }
    #auditLogModal .log-field-change {
        margin-left: 15px;
        font-size: 0.95em;
    }
    #auditLogModal .log-field-change .field-name {
        font-style: italic;
        color: #333;
    }
    #auditLogModal .log-field-change .old-value {
        color: #dc3545; /* Rojo para valor antiguo */
        text-decoration: line-through;
    }
    #auditLogModal .log-field-change .new-value {
        color: #28a745; /* Verde para valor nuevo */
    }
    .btn-audit {
        padding: 2px 6px;
        font-size: 11px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }
    .btn-audit:hover {
        background-color: #5a6268;
    }
  </style>
</head>

<body class="fondo-dinamico admin-page">
  <div class="container">
    <header style="margin-bottom: 30px;">
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Logo Districorr" style="max-height: 80px; display: block; margin: 0 auto 15px auto;" />
      <h2 style="text-align: center; color: #333; font-family: 'Poppins', sans-serif;">üìã Reportes Guardados y Estad√≠sticas</h2>
    </header>

    <div class="table-responsive">
      <table id="reportesTable" style="width:100%;">
        <thead>
          <tr>
            <th>Fecha Cirug√≠a</th>
            <th>Paciente</th>
            <th>M√©dico</th>
            <th>Cliente</th>
            <th>Tipo Cirug√≠a</th>
            <th>Material (Inicio)</th>
            <th>Archivos</th> <!-- NUEVA COLUMNA PARA ARCHIVOS -->
            <th>Usuario ID</th>
            <th>Guardado En</th>
            <th>√ölt. Modif.</th> <!-- NUEVA COLUMNA Auditor√≠a -->
            <th>Acciones</th> <!-- NUEVA COLUMNA ACCIONES (para log) -->
          </tr>
        </thead>
        <tbody id="reporte-rows">
           <tr><td colspan="11" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr> <!-- Colspan AUMENTADO A 11 -->
        </tbody>
      </table>
    </div>

    <!-- Secci√≥n de Estad√≠sticas -->
    <div class="stats-section">
        <h3>üìä Estad√≠sticas de Reportes</h3>
        <div id="loading-stats" style="text-align:center; color: #777; padding: 15px;">Cargando estad√≠sticas...</div>
        <div class="charts-container" style="display: none;">
            <div class="chart-wrapper">
                <canvas id="cirugiasPorMesChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="topMedicosChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="topTiposCirugiaChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="topClientesChart"></canvas>
            </div>
        </div>
    </div>
    <!-- Fin Secci√≥n de Estad√≠sticas -->

    <!-- Modal para el Log de Auditor√≠a -->
    <div id="auditLogModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="auditLogModalTitle">Historial de Cambios</h3>
                <button class="modal-close-btn" onclick="cerrarModalAuditLog()">√ó</button>
            </div>
            <div class="modal-body" id="auditLogModalBody">
                <!-- El log se cargar√° aqu√≠ -->
                <p style="text-align:center;">Cargando historial...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-link" onclick="cerrarModalAuditLog()">Cerrar</button>
            </div>
        </div>
    </div>


    <div style="text-align: center; margin-top: 30px;">
      <!-- ENLACE CORREGIDO -->
      <a href="index.html" class="btn-volver">‚Üê Volver al Formulario Principal</a>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase 
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E", 
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    db.enablePersistence()
      .catch((err) => {
         if (err.code == 'failed-precondition') {
          console.warn("Persistencia admin fall√≥: M√∫ltiples pesta√±as?");
        } else if (err.code == 'unimplemented') {
          console.warn("Persistencia admin no soportada.");
        } else {
          console.error("Error habilitando persistencia admin:", err);
        }
      });

    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            const partes = fechaISO.split('-');
            if (partes.length !== 3) return fechaISO;
            const fecha = new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]), 12, 0, 0);
            return fecha.toLocaleDateString('es-AR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) { return fechaISO; }
    }

    function formatearTimestamp(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        try {
            return timestamp.toDate().toLocaleString('es-AR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        } catch (e) { return '-'; }
    }
    
    let reportesDataGlobal = []; // Para usar en estad√≠sticas
    let charts = {}; // Para almacenar instancias de gr√°ficos y destruirlas


    function cargarReportes() {
      const tbody = document.getElementById("reporte-rows");
      const loadingStatsEl = document.getElementById("loading-stats");
      const chartsContainerEl = document.querySelector(".charts-container");

      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>`;
      loadingStatsEl.style.display = 'block';
      chartsContainerEl.style.display = 'none';


      db.collection("reportes")
        .orderBy("timestamp", "desc")
        .limit(200) // Aumentar un poco el l√≠mite para estad√≠sticas m√°s representativas
        .get()
        .then(snapshot => {
          tbody.innerHTML = ''; 
          reportesDataGlobal = []; // Limpiar datos globales antes de rellenar

          if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 20px; color: #777;">No hay reportes guardados todav√≠a.</td></tr>`;
            loadingStatsEl.textContent = 'No hay datos para generar estad√≠sticas.';
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id; // Guardar el ID del documento
            reportesDataGlobal.push(data); // Guardar datos para estad√≠sticas

            const fechaCirugiaFormateada = formatearFechaLocal(data.fechaCirugia);
            const fechaGuardadoFormateada = formatearTimestamp(data.timestamp);
            const fechaModificacionFormateada = data.modificadoEn ? formatearTimestamp(data.modificadoEn) : '-';
            
            const materialCortado = data.material
                ? (data.material.substring(0, 30) + (data.material.length > 30 ? '...' : ''))
                : '-';
            const usuarioIdCorto = data.usuario ? data.usuario.substring(0, 6) : (data.creadoPor ? data.creadoPor.substring(0,6) : 'An√≥n.');
            
            const tieneArchivos = data.archivosAdjuntos && data.archivosAdjuntos.length > 0;


            const tr = document.createElement("tr");
            tr.dataset.reportId = doc.id; // Para futuras acciones sobre la fila

            const createCell = (text, isHtml = false) => {
                const td = document.createElement('td');
                if (isHtml) {
                    td.innerHTML = text || '-';
                } else {
                    td.textContent = text || '-';
                }
                return td;
            };
            
            let archivosHtml = '-';
            if (tieneArchivos) {
                archivosHtml = data.archivosAdjuntos.map(archivo => 
                    `<a href="${archivo.url}" target="_blank" title="${archivo.nombre}" style="font-size:1.2em; margin-right: 5px;">üìÑ</a>`
                ).join('');
            }


            tr.appendChild(createCell(fechaCirugiaFormateada));
            tr.appendChild(createCell(data.paciente));
            tr.appendChild(createCell(data.medico));
            tr.appendChild(createCell(data.cliente));
            tr.appendChild(createCell(data.tipoCirugia));
            tr.appendChild(createCell(materialCortado));
            tr.appendChild(createCell(archivosHtml, true)); // Celda para archivos
            tr.appendChild(createCell(usuarioIdCorto));
            tr.appendChild(createCell(fechaGuardadoFormateada));
            tr.appendChild(createCell(fechaModificacionFormateada)); // Celda para √öltima Modificaci√≥n
            
            // Celda de Acciones (para bot√≥n de Auditor√≠a)
            const tdActions = document.createElement('td');
            const auditButton = document.createElement('button');
            auditButton.textContent = 'Ver Log';
            auditButton.classList.add('btn-audit');
            auditButton.onclick = () => abrirModalAuditLog(doc.id, data.paciente);
            tdActions.appendChild(auditButton);
            tr.appendChild(tdActions);

            tbody.appendChild(tr);
          });
          
          // Una vez cargados los reportes, generar estad√≠sticas
          loadingStatsEl.style.display = 'none';
          chartsContainerEl.style.display = 'flex';
          generarEstadisticas();

        })
        .catch(error => {
          console.error('Error cargando reportes:', error);
          tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 20px; color:red;">Error al cargar los reportes. Revise la consola.</td></tr>`;
          loadingStatsEl.textContent = 'Error al cargar datos para estad√≠sticas.';
        });
    }
    
    function abrirModalAuditLog(reporteId, pacienteNombre) {
        const modal = document.getElementById('auditLogModal');
        const modalTitle = document.getElementById('auditLogModalTitle');
        const modalBody = document.getElementById('auditLogModalBody');

        if (!modal || !modalTitle || !modalBody) {
            console.error("Elementos del modal de auditor√≠a no encontrados.");
            return;
        }

        modalTitle.textContent = `Historial de Cambios: ${pacienteNombre || 'Reporte ' + reporteId.substring(0,6)}`;
        modalBody.innerHTML = '<p style="text-align:center;">Cargando historial...</p>';
        modal.style.display = 'flex'; // Mostrar modal

        db.collection('reportes').doc(reporteId).collection('auditLog')
            .orderBy('timestamp', 'desc')
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    modalBody.innerHTML = '<p style="text-align:center;">No hay historial de cambios para este reporte.</p>';
                    return;
                }
                modalBody.innerHTML = ''; // Limpiar "cargando"
                snapshot.forEach(logDoc => {
                    const logData = logDoc.data();
                    const entryDiv = document.createElement('div');
                    entryDiv.classList.add('log-entry');

                    const user = logData.usuarioId ? logData.usuarioId.substring(0,6) : 'Sistema';
                    let html = `<span class="log-timestamp">${formatearTimestamp(logData.timestamp)}</span>`;
                    html += `<span class="log-user">Usuario: ${user}</span>`;
                    html += `<span class="log-action">Acci√≥n: ${logData.accion || 'Modificaci√≥n'}</span>`;

                    if (logData.cambios && logData.cambios.length > 0) {
                        html += '<div class="log-details-title">Detalles:</div>';
                        logData.cambios.forEach(cambio => {
                            html += `<div class="log-field-change">
                                        <span class="field-name">${cambio.campo}:</span> 
                                        <span class="old-value">${cambio.anterior !== undefined ? cambio.anterior : 'N/A'}</span> ‚Üí 
                                        <span class="new-value">${cambio.nuevo !== undefined ? cambio.nuevo : 'N/A'}</span>
                                     </div>`;
                        });
                    }
                    entryDiv.innerHTML = html;
                    modalBody.appendChild(entryDiv);
                });
            })
            .catch(error => {
                console.error("Error cargando log de auditor√≠a:", error);
                modalBody.innerHTML = '<p style="text-align:center; color:red;">Error al cargar el historial.</p>';
            });
    }

    function cerrarModalAuditLog() {
        const modal = document.getElementById('auditLogModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }


    // --- Funciones de Estad√≠sticas ---
    function generarEstadisticas() {
        if (reportesDataGlobal.length === 0) {
            console.log("No hay datos para generar estad√≠sticas.");
            document.getElementById("loading-stats").textContent = 'No hay suficientes datos para estad√≠sticas.';
            document.querySelector(".charts-container").style.display = 'none';
            return;
        }
        
        // Destruir gr√°ficos anteriores si existen para evitar solapamientos
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        // 1. Cirug√≠as por Mes
        const cirugiasPorMes = {};
        reportesDataGlobal.forEach(r => {
            if (r.fechaCirugia) {
                const mesAnio = r.fechaCirugia.substring(0, 7); // YYYY-MM
                cirugiasPorMes[mesAnio] = (cirugiasPorMes[mesAnio] || 0) + 1;
            }
        });
        const labelsMeses = Object.keys(cirugiasPorMes).sort();
        const dataMeses = labelsMeses.map(label => cirugiasPorMes[label]);
        crearGrafico('cirugiasPorMesChart', 'bar', 'Cirug√≠as por Mes', labelsMeses, dataMeses, 'N¬∫ de Cirug√≠as');

        // 2. Top M√©dicos
        const conteoMedicos = {};
        reportesDataGlobal.forEach(r => {
            if (r.medico) conteoMedicos[r.medico] = (conteoMedicos[r.medico] || 0) + 1;
        });
        const topMedicos = Object.entries(conteoMedicos).sort((a, b) => b[1] - a[1]).slice(0, 10); // Top 10
        crearGrafico('topMedicosChart', 'pie', 'Top M√©dicos', topMedicos.map(m => m[0]), topMedicos.map(m => m[1]));

        // 3. Top Tipos de Cirug√≠a
        const conteoTiposCx = {};
        reportesDataGlobal.forEach(r => {
            if (r.tipoCirugia) conteoTiposCx[r.tipoCirugia] = (conteoTiposCx[r.tipoCirugia] || 0) + 1;
        });
        const topTiposCx = Object.entries(conteoTiposCx).sort((a, b) => b[1] - a[1]).slice(0, 10);
        crearGrafico('topTiposCirugiaChart', 'doughnut', 'Top Tipos de Cirug√≠a', topTiposCx.map(t => t[0]), topTiposCx.map(t => t[1]));
        
        // 4. Top Clientes
        const conteoClientes = {};
        reportesDataGlobal.forEach(r => {
            if (r.cliente) conteoClientes[r.cliente] = (conteoClientes[r.cliente] || 0) + 1;
        });
        const topClientes = Object.entries(conteoClientes).sort((a,b) => b[1] - a[1]).slice(0,10);
        crearGrafico('topClientesChart', 'bar', 'Top Clientes', topClientes.map(c => c[0]), topClientes.map(c => c[1]), 'N¬∫ de Reportes');

    }

    function crearGrafico(canvasId, tipo, tituloLabel, labels, data, dataLabel = 'Cantidad') {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error(`Canvas con ID ${canvasId} no encontrado.`);
            return;
        }
        charts[canvasId] = new Chart(ctx.getContext('2d'), {
            type: tipo,
            data: {
                labels: labels,
                datasets: [{
                    label: dataLabel,
                    data: data,
                    backgroundColor: tipo === 'bar' ? 'rgba(0, 123, 255, 0.5)' : [ // Colores para pie/doughnut
                        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                        'rgba(201, 203, 207, 0.7)', 'rgba(0, 255, 255, 0.7)',
                        'rgba(255, 0, 255, 0.7)', 'rgba(128, 0, 128, 0.7)'
                    ],
                    borderColor: tipo === 'bar' ? 'rgba(0, 123, 255, 1)' : '#fff',
                    borderWidth: tipo === 'bar' ? 1 : 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: tituloLabel, font: { size: 16 } },
                    legend: { display: tipo !== 'bar', position: 'top' }
                },
                scales: tipo === 'bar' ? { y: { beginAtZero: true } } : {}
            }
        });
    }

    window.onload = function () {
      document.body.style.backgroundColor = "#f0f2f5";
      cargarReportes();
      
      // Listener para cerrar el modal de auditor√≠a haciendo clic fuera
        const auditModal = document.getElementById('auditLogModal');
        if (auditModal) {
            auditModal.addEventListener('click', function(event) {
                if (event.target === this) { // Si el clic fue directamente en el overlay
                    cerrarModalAuditLog();
                }
            });
        }
    };
  </script>
</body>
</html>
