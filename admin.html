<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control y Reportes | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Lato&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="fondo-dinamico admin-page">
  <div class="container">
    <header style="margin-bottom: 20px;">
      <img src="aA7RzTN.png" alt="Logo Districorr" style="max-height: 70px; display: block; margin: 0 auto 10px auto;" />
      <h2 style="text-align: center; color: #333; font-family: 'Poppins', sans-serif;">üìä Panel de Control y Reportes</h2>
    </header>

    <div class="admin-stats-container">
        <div class="stat-card">
            <h4>Reportes Totales</h4>
            <p class="stat-value" id="statTotalReportes">Cargando...</p>
        </div>
        <div class="stat-card">
            <h4>Reportes Hoy</h4>
            <p class="stat-value" id="statReportesHoy">Cargando...</p>
        </div>
        <div class="stat-card">
            <h4><span id="labelReportesSemana">Reportes (√öltimos 7 d√≠as)</span></h4>
            <div class="chart-container"><canvas id="reportesSemanaChart"></canvas></div>
        </div>
        <div class="stat-card">
            <h4><span id="labelTopTiposCx">Top 5 Tipos de Cirug√≠a</span></h4>
            <div class="chart-container"><canvas id="topTiposCxChart"></canvas></div>
        </div>
    </div>

    <div class="admin-filters-container">
        <div class="form-group">
            <label for="searchInputAdmin">Buscar General:</label>
            <input type="text" id="searchInputAdmin" class="form-control" placeholder="Cliente, Paciente o M√©dico..." onkeyup="filtrarTablaAdmin()">
        </div>
        <div class="form-group">
            <label for="filtroFechaDesde">Fecha Cirug√≠a Desde:</label>
            <input type="date" id="filtroFechaDesde" class="form-control" onchange="filtrarTablaAdmin()">
        </div>
        <div class="form-group">
            <label for="filtroFechaHasta">Fecha Cirug√≠a Hasta:</label>
            <input type="date" id="filtroFechaHasta" class="form-control" onchange="filtrarTablaAdmin()">
        </div>
        <div class="form-group">
            <label for="filtroMedicoGraficos">Filtrar Gr√°ficos por M√©dico:</label>
            <select id="filtroMedicoGraficos" class="form-control" onchange="actualizarGraficosConFiltros()">
                <option value="">Todos los M√©dicos</option>
            </select>
        </div>
        <div class="form-group">
            <label for="filtroClienteGraficos">Filtrar Gr√°ficos por Cliente:</label>
            <select id="filtroClienteGraficos" class="form-control" onchange="actualizarGraficosConFiltros()">
                <option value="">Todos los Clientes</option>
            </select>
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end;">
             <button onclick="limpiarFiltrosFecha()" class="btn-secundario" style="width: 100%;">Limpiar Fechas</button>
        </div>
    </div>

    <div id="newReportNotification">
        ¬°Hay nuevos reportes! <a href="#" onclick="cargarReportesAdmin(true); this.parentNode.style.display='none'; return false;">Actualizar lista para verlos</a>
    </div>

    <div id="exportBtnContainer">
        <button onclick="exportTableToCSV('reportesTableAdmin', 'reportes_districorr.csv')" class="btn-secundario">üìÑ Exportar a CSV</button>
    </div>

    <div class="table-responsive">
      <table id="reportesTableAdmin" style="width:100%;">
        <thead>
          <tr>
            <th>Fecha Cir.</th>
            <th>Cliente</th>
            <th>Paciente</th>
            <th>M√©dico</th>
            <th>Tipo Cirug√≠a</th>
            <th class="col-acciones-header">Acciones</th>
          </tr>
        </thead>
        <tbody id="reporte-rows-admin">
           <tr><td colspan="6" style="text-align:center; padding: 20px; color: #555;">Cargando reportes...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" class="btn-volver">‚Üê Volver al formulario</a>
    </div>
  </div>

  <div id="modalReporteDetalle" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header"><h3>Detalle del Reporte</h3><button class="modal-close-btn" onclick="cerrarModalReporteDetalle()">√ó</button></div>
      <div class="modal-body" id="modalReporteDetalleBody"></div>
      <div class="modal-footer"><button type="button" class="btn-link" onclick="cerrarModalReporteDetalle()">Cerrar</button></div>
    </div>
  </div>
  <div id="toast" class="toast-notification" style="display:none;"></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E", // TU API KEY
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let todosLosReportes = [];
    let reportesFiltradosParaGraficos = [];
    let reportesSemanaChartInstance = null;
    let topTiposCxChartInstance = null;
    let listenerNuevosReportesUnsubscribe = null;

    db.enablePersistence().catch(err => console.warn("Persistencia admin:", err.code));

    // --- Funciones de Utilidad y Formato ---
    function mostrarToastAdmin(mensaje, tipo = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = mensaje;
        toast.className = 'toast-notification';
        toast.classList.add(tipo);
        toast.style.display = 'block';
        void toast.offsetWidth;
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            setTimeout(() => { toast.style.display = 'none'; }, 300);
        }, 3000);
    }

    function formatearFechaLocal(fechaISO) {
        if (!fechaISO) return '-';
        try {
            const [year, month, day] = fechaISO.split('-');
            return `${day}/${month}/${year}`;
        } catch (e) {
            return fechaISO;
        }
    }
    
    function formatearFechaUsuario(fechaISO) {
        if (!fechaISO) return 'No especificada';
        try {
            const p = fechaISO.split('-');
            if (p.length !== 3) return fechaISO;
            const f = new Date(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2]), 12);
            return f.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        } catch (e) { return fechaISO; }
    }

    function formatearMaterialParaHTMLAdmin(materialTexto) {
        if (!materialTexto) return '<p>No especificado.</p>';
        const lineas = materialTexto.split('\n').filter(l => l.trim() !== '');
        if (lineas.length === 0) return '<p>No especificado.</p>';
        let html = '<ul style="padding-left: 20px; margin: 0;">';
        lineas.forEach(l => { html += `<li>${l.trim()}</li>`; });
        return html + '</ul>';
    }

    function generarHTMLReporteAdmin(datos) {
        return `
          <div class="reporte-contenido reporte-box">
            <p>${datos.mensajeInicio || 'Detalles de la cirug√≠a programada:'}</p>
            <ul>
              <li><strong>Cliente:</strong> ${datos.cliente || 'No especificado'}</li>
              <li><strong>Paciente:</strong> ${datos.paciente || 'No especificado'}</li>
              <li><strong>Tipo de Cirug√≠a:</strong> ${datos.tipoCirugia || 'No especificado'}</li>
              <li><strong>M√©dico Responsable:</strong> ${datos.medico || 'No especificado'}</li>
              <li><strong>Instrumentador:</strong> ${datos.instrumentador || 'No especificado'}</li>
              <li><strong>Fecha de Cirug√≠a:</strong> ${formatearFechaUsuario(datos.fechaCirugia)}</li>
              <li><strong>Lugar:</strong> ${datos.lugarCirugia || 'No especificado'}</li>
            </ul>
            <h4>Material Requerido:</h4>
            ${formatearMaterialParaHTMLAdmin(datos.material)}
            ${datos.observaciones ? `<h4>Observaciones:</h4><p>${datos.observaciones.replace(/\n/g, '<br>')}</p>` : ''}
            ${datos.infoAdicional ? `<h4>Informaci√≥n Adicional:</h4><p>${datos.infoAdicional.replace(/\n/g, '<br>')}</p>` : ''}
          </div>`;
    }
    
    function generarTextoPlanoReporte(datos) {
        const materialPlano = (datos.material || 'No especificado').split('\n').map(l => `- ${l.trim()}`).join('\n');
        const observacionesPlano = datos.observaciones ? `\nObservaciones:\n${datos.observaciones}` : '';
        const infoAdicionalPlano = datos.infoAdicional ? `\nInformaci√≥n Adicional:\n${datos.infoAdicional}` : '';

        return `${datos.mensajeInicio || 'Detalles de la cirug√≠a programada:'}
Cliente: ${datos.cliente || 'No especificado'}
Paciente: ${datos.paciente || 'No especificado'}
Tipo de Cirug√≠a: ${datos.tipoCirugia || 'No especificado'}
M√©dico Responsable: ${datos.medico || 'No especificado'}
Instrumentador: ${datos.instrumentador || 'No especificado'}
Fecha de Cirug√≠a: ${formatearFechaUsuario(datos.fechaCirugia)}
Lugar: ${datos.lugarCirugia || 'No especificado'}

Material Requerido:
${materialPlano}
${observacionesPlano}
${infoAdicionalPlano}

Saludos, quedo al pendiente.`;
    }

    // --- Funciones del Modal y Acciones ---
    function abrirModalReporteDetalle(reporteData) {
        const modalBody = document.getElementById('modalReporteDetalleBody');
        modalBody.innerHTML = generarHTMLReporteAdmin(reporteData);
        document.getElementById('modalReporteDetalle').style.display = 'flex';
    }

    function cerrarModalReporteDetalle() {
        document.getElementById('modalReporteDetalle').style.display = 'none';
    }

    function reenviarWhatsAppAdmin(reporteData) {
        const texto = `*Reporte Cirug√≠a Districorr*\n\n${generarTextoPlanoReporte(reporteData)}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`, '_blank');
    }
    
    async function copiarReporteAdmin(reporteData) {
        const texto = generarTextoPlanoReporte(reporteData);
        try {
            await navigator.clipboard.writeText(texto);
            mostrarToastAdmin('Reporte copiado al portapapeles.', 'success');
        } catch (err) {
            console.error('Error al copiar reporte:', err);
            mostrarToastAdmin('Error al copiar el reporte.', 'error');
        }
    }

    // --- Exportaci√≥n y Filtros ---
    function exportTableToCSV(tableId, filename) {
        let csv = [];
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll("tr");
        for (const row of rows) {
            if (row.classList.contains('fila-oculta') && row.parentNode.tagName === 'TBODY') continue;
            const cols = row.querySelectorAll("td, th");
            let rowData = [];
            for (let i = 0; i < cols.length; i++) {
                const col = cols[i];
                if (col.classList.contains('col-acciones') || col.classList.contains('col-acciones-header')) continue;
                let data = col.innerText.replace(/"/g, '""');
                rowData.push(`"${data}"`);
            }
            if (rowData.length > 0) csv.push(rowData.join(","));
        }
        if (csv.length <= 1) { mostrarToastAdmin('No hay datos visibles para exportar.', 'warning'); return; }
        const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
        const downloadLink = document.createElement("a");
        downloadLink.download = filename;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        mostrarToastAdmin('Tabla exportada a CSV.', 'success');
    }
    
    function limpiarFiltrosFecha() {
        document.getElementById('filtroFechaDesde').value = '';
        document.getElementById('filtroFechaHasta').value = '';
        filtrarTablaAdmin();
    }

    // --- Gr√°ficos y Estad√≠sticas ---
    function poblarFiltrosGraficos() {
        const medicos = [...new Set(todosLosReportes.map(r => r.medico).filter(Boolean))].sort();
        const clientes = [...new Set(todosLosReportes.map(r => r.cliente).filter(Boolean))].sort();

        const filtroMedicoSelect = document.getElementById('filtroMedicoGraficos');
        const filtroClienteSelect = document.getElementById('filtroClienteGraficos');

        filtroMedicoSelect.innerHTML = '<option value="">Todos los M√©dicos</option>';
        medicos.forEach(m => {
            const option = document.createElement('option');
            option.value = m; option.textContent = m;
            filtroMedicoSelect.appendChild(option);
        });

        filtroClienteSelect.innerHTML = '<option value="">Todos los Clientes</option>';
        clientes.forEach(c => {
            const option = document.createElement('option');
            option.value = c; option.textContent = c;
            filtroClienteSelect.appendChild(option);
        });
    }

    function actualizarGraficosConFiltros() {
        const medicoFiltro = document.getElementById('filtroMedicoGraficos').value;
        const clienteFiltro = document.getElementById('filtroClienteGraficos').value;
        
        document.getElementById('labelReportesSemana').textContent = `Reportes (√ölt. 7 d√≠as) ${medicoFiltro ? `- ${medicoFiltro}` : ''} ${clienteFiltro ? `- ${clienteFiltro}` : ''}`;
        document.getElementById('labelTopTiposCx').textContent = `Top Tipos Cx ${medicoFiltro ? `- ${medicoFiltro}` : ''} ${clienteFiltro ? `- ${clienteFiltro}` : ''}`;

        reportesFiltradosParaGraficos = todosLosReportes.filter(r => {
            const medicoMatch = !medicoFiltro || r.medico === medicoFiltro;
            const clienteMatch = !clienteFiltro || r.cliente === clienteFiltro;
            return medicoMatch && clienteMatch;
        });
        cargarEstadisticasYGraficos(reportesFiltradosParaGraficos);
    }

    async function cargarEstadisticasYGraficos(dataSource = todosLosReportes) {
        if (dataSource.length === 0 && todosLosReportes.length === 0) {
             document.getElementById('statTotalReportes').textContent = '0';
             document.getElementById('statReportesHoy').textContent = '0';
            if (reportesSemanaChartInstance) reportesSemanaChartInstance.destroy();
            if (topTiposCxChartInstance) topTiposCxChartInstance.destroy();
            document.getElementById('reportesSemanaChart').parentNode.innerHTML = '<p style="text-align:center; color:#777; margin-top:50px;">No hay datos.</p>';
            document.getElementById('topTiposCxChart').parentNode.innerHTML = '<p style="text-align:center; color:#777; margin-top:50px;">No hay datos.</p>';
            return;
        }
        
        document.getElementById('statTotalReportes').textContent = todosLosReportes.length;
        const hoy = new Date();
        const inicioHoyTS = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(),0,0,0).getTime();
        const finHoyTS = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(),23,59,59).getTime();
        const reportesHoy = todosLosReportes.filter(r => r.timestamp?.toDate()?.getTime() >= inicioHoyTS && r.timestamp?.toDate()?.getTime() <= finHoyTS);
        document.getElementById('statReportesHoy').textContent = reportesHoy.length;

        const reportesPorDia = {};
        for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(hoy.getDate() - i); reportesPorDia[`${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`] = 0; }
        dataSource.forEach(r => {
            if (!r.timestamp || !r.timestamp.toDate) return;
            const fechaReporte = r.timestamp.toDate();
            const haceSieteDias = new Date(); haceSieteDias.setDate(hoy.getDate() - 6); haceSieteDias.setHours(0,0,0,0);
            if (fechaReporte >= haceSieteDias) { const key = `${fechaReporte.getDate().toString().padStart(2,'0')}/${(fechaReporte.getMonth()+1).toString().padStart(2,'0')}`; if (reportesPorDia[key] !== undefined) reportesPorDia[key]++; }
        });
        
        const ctxSemana = document.getElementById('reportesSemanaChart');
        if (ctxSemana.tagName !== 'CANVAS') {
            ctxSemana.parentNode.innerHTML = '<canvas id="reportesSemanaChart"></canvas>';
        }
        if (reportesSemanaChartInstance) reportesSemanaChartInstance.destroy();
        reportesSemanaChartInstance = new Chart(document.getElementById('reportesSemanaChart'), { type: 'line', data: { labels: Object.keys(reportesPorDia), datasets: [{ label: 'Reportes', data: Object.values(reportesPorDia), borderColor: 'rgb(0, 123, 255)', backgroundColor:'rgba(0, 123, 255, 0.1)', tension: 0.1, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } } } });

        const conteoTiposCx = {};
        dataSource.forEach(r => { if (r.tipoCirugia?.trim()) conteoTiposCx[r.tipoCirugia.trim()] = (conteoTiposCx[r.tipoCirugia.trim()] || 0) + 1; });
        const sortedTiposCx = Object.entries(conteoTiposCx).sort(([,a],[,b]) => b-a).slice(0, 5);
        
        const ctxTipos = document.getElementById('topTiposCxChart');
        if (ctxTipos.tagName !== 'CANVAS') {
            ctxTipos.parentNode.innerHTML = '<canvas id="topTiposCxChart"></canvas>';
        }
        if (topTiposCxChartInstance) topTiposCxChartInstance.destroy();
        if (sortedTiposCx.length > 0) {
            topTiposCxChartInstance = new Chart(document.getElementById('topTiposCxChart'), { type: 'doughnut', data: { labels: sortedTiposCx.map(item => item[0]), datasets: [{ data: sortedTiposCx.map(item => item[1]), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#dc3545', '#6c757d'].slice(0, sortedTiposCx.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: {boxWidth:12, padding:10, font: {size: 10}} } } } });
        } else {
             document.getElementById('topTiposCxChart').parentNode.innerHTML = '<p style="text-align:center; color:#777; margin-top:50px;">No hay datos de tipos de cirug√≠a para mostrar con los filtros actuales.</p>';
        }
    }

    // --- Carga Principal de Datos y Renderizado de Tabla ---
    async function cargarReportesAdmin(forzarRecargaCompleta = false) {
      const tbody = document.getElementById("reporte-rows-admin");
      let actualizarDatosGlobales = forzarRecargaCompleta || todosLosReportes.length === 0;

      if (actualizarDatosGlobales) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px; color: #555;">Cargando y procesando reportes...</td></tr>`;
          try {
            const snapshot = await db.collection("reportes").orderBy("fechaCirugia", "desc").limit(500).get(); // Ordenar por fecha de cirug√≠a y l√≠mite mayor
            todosLosReportes = [];
            snapshot.forEach(doc => { const data = doc.data(); data.id = doc.id; todosLosReportes.push(data); });
            poblarFiltrosGraficos();
          } catch (error) {
              console.error('Error cargando reportes admin:', error);
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:red;">Error al cargar datos.</td></tr>`;
              document.getElementById('statTotalReportes').textContent = 'Error'; document.getElementById('statReportesHoy').textContent = 'Error';
              return;
          }
      }

      tbody.innerHTML = '';
      const reportesParaMostrar = todosLosReportes;

      if (reportesParaMostrar.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px; color: #777;">No hay reportes guardados.</td></tr>`;
      } else {
          reportesParaMostrar.forEach(data => {
            const tr = document.createElement("tr");
            tr.dataset.reporteId = data.id;

            const createCellInternal = (text, className = '') => { const td = document.createElement('td'); td.textContent = text || '-'; if(className) td.classList.add(className); return td; };
            tr.appendChild(createCellInternal(formatearFechaLocal(data.fechaCirugia)));
            tr.appendChild(createCellInternal(data.cliente, 'col-cliente'));
            tr.appendChild(createCellInternal(data.paciente, 'col-paciente'));
            tr.appendChild(createCellInternal(data.medico, 'col-medico'));
            tr.appendChild(createCellInternal(data.tipoCirugia ? (data.tipoCirugia.length > 23 ? data.tipoCirugia.substring(0,20)+'...' : data.tipoCirugia) : '-', 'col-tipocx'));
            
            const tdActions = document.createElement('td');
            tdActions.classList.add('col-acciones');
            
            const btnVer = document.createElement('button');
            btnVer.textContent = 'Ver';
            btnVer.classList.add('btn-admin-action', 'btn-admin-ver');
            btnVer.onclick = function() { abrirModalReporteDetalle(data); };
            tdActions.appendChild(btnVer);
            
            const btnCopiar = document.createElement('button');
            btnCopiar.innerHTML = 'üìã';
            btnCopiar.title = 'Copiar Reporte';
            btnCopiar.classList.add('btn-admin-action', 'btn-admin-copiar');
            btnCopiar.onclick = function() { copiarReporteAdmin(data); };
            tdActions.appendChild(btnCopiar);

            const btnWsp = document.createElement('button');
            btnWsp.innerHTML = 'üì≤';
            btnWsp.title = 'Reenviar WhatsApp';
            btnWsp.classList.add('btn-admin-action', 'btn-admin-wsp');
            btnWsp.onclick = function() { reenviarWhatsAppAdmin(data); };
            tdActions.appendChild(btnWsp);
            
            tr.appendChild(tdActions);
            tbody.appendChild(tr);
          });
      }
      
      if (actualizarDatosGlobales || forzarRecargaCompleta) {
         await actualizarGraficosConFiltros();
      }
      filtrarTablaAdmin();
      if (forzarRecargaCompleta) {
         document.getElementById('newReportNotification').style.display = 'none';
         if (todosLosReportes.length > 0 && todosLosReportes[0].timestamp) {
             localStorage.setItem('adminLastReportTimestamp', todosLosReportes[0].timestamp.toMillis());
         }
      }
    }

    function escucharNuevosReportes() {
        if (listenerNuevosReportesUnsubscribe) listenerNuevosReportesUnsubscribe();
        let adminLastKnownTimestamp = localStorage.getItem('adminLastReportTimestamp') ? parseInt(localStorage.getItem('adminLastReportTimestamp')) : 0;
        
        const setupListener = (refTimestamp) => {
            let query = db.collection("reportes").orderBy("timestamp", "desc");
            if (refTimestamp > 0) query = query.where("timestamp", ">", firebase.firestore.Timestamp.fromMillis(refTimestamp));
            
            listenerNuevosReportesUnsubscribe = query.onSnapshot((snapshot) => {
                let hayNuevosEsteSnapshot = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const nuevoTimestampMillis = change.doc.data().timestamp.toMillis();
                        if (nuevoTimestampMillis > refTimestamp) {
                            hayNuevosEsteSnapshot = true;
                            if (nuevoTimestampMillis > parseInt(localStorage.getItem('adminLastReportTimestamp') || '0') ) {
                                localStorage.setItem('adminLastReportTimestamp', nuevoTimestampMillis);
                            }
                        }
                    }
                });
                if (hayNuevosEsteSnapshot && document.getElementById('newReportNotification').style.display === 'none') {
                    document.getElementById('newReportNotification').style.display = 'block';
                    mostrarToastAdmin('¬°Nuevos reportes disponibles!', 'info');
                }
            }, (error) => console.error("Error escuchando nuevos reportes: ", error));
        };

        if (todosLosReportes.length === 0 && adminLastKnownTimestamp === 0) {
            db.collection("reportes").orderBy("timestamp", "desc").limit(1).get().then(snapshot => {
                if (!snapshot.empty) {
                    adminLastKnownTimestamp = snapshot.docs[0].data().timestamp.toMillis();
                    localStorage.setItem('adminLastReportTimestamp', adminLastKnownTimestamp);
                }
                setupListener(adminLastKnownTimestamp);
            }).catch(err => { console.error("Error obteniendo TS inicial", err); setupListener(0); });
        } else {
            setupListener(adminLastKnownTimestamp);
        }
    }

    function filtrarTablaAdmin() {
        const filtroTexto = document.getElementById("searchInputAdmin").value.toUpperCase().trim();
        const filtroDesde = document.getElementById("filtroFechaDesde").value;
        const filtroHasta = document.getElementById("filtroFechaHasta").value;
        const tbody = document.getElementById("reporte-rows-admin");
        const rows = tbody.getElementsByTagName("tr");
        let hayResultados = false;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (!row.dataset.reporteId) { row.classList.remove('fila-oculta'); continue; }
            
            const reporteId = row.dataset.reporteId;
            const reporteData = todosLosReportes.find(r => r.id === reporteId);
            let mostrarFila = true;

            if (reporteData) {
                // Filtro por texto general
                if (filtroTexto !== "") {
                    const cliente = (reporteData.cliente || "").toUpperCase();
                    const paciente = (reporteData.paciente || "").toUpperCase();
                    const medico = (reporteData.medico || "").toUpperCase();
                    if (!(cliente.includes(filtroTexto) || paciente.includes(filtroTexto) || medico.includes(filtroTexto))) {
                        mostrarFila = false;
                    }
                }
                
                // Filtro por rango de fechas
                const fechaCirugia = reporteData.fechaCirugia; // Formato YYYY-MM-DD
                if (mostrarFila && fechaCirugia) {
                    if (filtroDesde && fechaCirugia < filtroDesde) {
                        mostrarFila = false;
                    }
                    if (filtroHasta && fechaCirugia > filtroHasta) {
                        mostrarFila = false;
                    }
                }

                if (mostrarFila) {
                    row.classList.remove('fila-oculta');
                    hayResultados = true;
                } else {
                    row.classList.add('fila-oculta');
                }
            } else {
                row.classList.add('fila-oculta');
            }
        }

        const noResultsRowId = 'no-results-row';
        let noResultsRow = document.getElementById(noResultsRowId);
        if (!hayResultados && (filtroTexto !== "" || filtroDesde || filtroHasta)) {
            if (!noResultsRow) {
                noResultsRow = tbody.insertRow();
                noResultsRow.id = noResultsRowId;
                const cell = noResultsRow.insertCell();
                cell.colSpan = 6; // Ajustar colspan al nuevo n√∫mero de columnas
                cell.textContent = "No se encontraron reportes que coincidan con los filtros.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                cell.style.color = "#777";
            }
        } else if (noResultsRow) {
            noResultsRow.remove();
        }
    }
    
    window.onload = async function () {
      document.body.style.backgroundColor = "#f0f2f5";
      await cargarReportesAdmin(true); 
      escucharNuevosReportes(); 
      const modalDetalle = document.getElementById('modalReporteDetalle');
      if (modalDetalle) modalDetalle.addEventListener('click', function(event) { if (event.target === this) cerrarModalReporteDetalle(); });
    };
</script>
</body>
</html>